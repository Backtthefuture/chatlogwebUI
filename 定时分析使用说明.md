# 定时分析功能使用说明

## 功能概述

定时分析功能可以让系统在指定时间自动执行"一键全分析"，无需手动操作即可定期生成聊天记录分析报告。

## 配置方法

### 方法一：环境变量配置（推荐）

1. **复制配置文件模板**
   ```bash
   cp env.example .env
   ```

2. **编辑.env文件，添加以下配置**
   ```bash
   # 启用定时分析
   ENABLE_SCHEDULED_ANALYSIS=true
   
   # 设置执行时间（Cron表达式）
   SCHEDULED_ANALYSIS_TIME=0 8 * * *
   
   # 配置DeepSeek API密钥
   DEEPSEEK_API_KEY=your-deepseek-api-key-here
   ```

3. **启动服务**
   ```bash
   npm start
   ```

### 方法二：使用启动脚本

直接运行提供的启动脚本：
```bash
./start-with-scheduler.sh
```

## Cron时间表达式说明

Cron表达式格式：`秒 分 时 日 月 星期`

### 常用时间配置示例

| 表达式 | 说明 |
|--------|------|
| `0 8 * * *` | 每天早上8点 |
| `0 9 * * 1-5` | 工作日早上9点 |
| `0 20 * * *` | 每天晚上8点 |
| `0 */6 * * *` | 每6小时执行一次 |
| `0 0 * * 0` | 每周日午夜 |
| `0 0 1 * *` | 每月1号午夜 |

### 时间字段说明

- **秒**: 0-59
- **分**: 0-59  
- **时**: 0-23
- **日**: 1-31
- **月**: 1-12
- **星期**: 0-7 (0和7都表示周日)

## 分析项配置

定时分析会自动执行所有已配置的分析项，包括：

1. **默认分析项**
   - 编程群分析
   - 科学群分析  
   - 读者群分析

2. **自定义分析项**
   - 通过"新增分析项"添加的动态分析项

### 配置要求

每个分析项必须配置：
- ✅ 群聊名称
- ✅ 分析提示词
- ✅ 显示名称（可选）

## 使用流程

### 1. 配置分析项

1. 在Web界面中点击各分析项的"设置"按钮
2. 选择要分析的群聊
3. 设置分析提示词
4. 保存配置

### 2. 启用定时任务

1. 在.env文件中设置 `ENABLE_SCHEDULED_ANALYSIS=true`
2. 配置执行时间 `SCHEDULED_ANALYSIS_TIME`
3. 重启服务

### 3. 监控执行状态

1. 在Web界面的"定时分析管理"区域查看状态
2. 可以手动触发测试
3. 查看服务器日志了解执行详情

## 分析规则

### 时间范围
- 定时分析默认分析**昨天**的聊天数据
- 如果昨天无聊天数据，会跳过该分析项

### 执行顺序
- 按配置顺序逐个执行分析项
- 每个分析项间隔3秒，避免API频率限制
- 失败的分析项不会影响后续分析

### 结果保存
- 分析结果自动保存到历史记录
- 标题前缀为"[定时]"便于识别
- 可在"分析历史记录"中查看

## 故障排除

### 1. 定时任务未执行

**检查项：**
- ✅ 是否设置了 `ENABLE_SCHEDULED_ANALYSIS=true`
- ✅ Cron表达式是否正确
- ✅ 服务是否正常运行
- ✅ 是否有配置的分析项

**解决方法：**
```bash
# 查看服务器启动日志
npm start

# 检查定时任务状态
curl http://localhost:3000/api/scheduled-analysis-status
```

### 2. 分析项未找到

**原因：** 分析项配置不完整

**解决方法：**
1. 检查每个分析项是否配置了群聊名称
2. 确认群聊名称与实际群聊匹配
3. 重新保存分析项配置

### 3. API调用失败

**原因：** DeepSeek API密钥问题

**解决方法：**
1. 检查.env文件中的API密钥是否正确
2. 确认API密钥有足够的调用额度
3. 测试API连接：访问 `/api/test-deepseek`

### 4. 手动触发失败

**检查项：**
- ✅ Chatlog服务是否运行（端口5030）
- ✅ 是否有昨天的聊天数据
- ✅ 网络连接是否正常

## 高级配置

### 自定义分析时间范围

如需修改分析的时间范围，可以编辑 `server.js` 中的 `executeScheduledAnalysis` 函数：

```javascript
// 默认分析昨天
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);

// 修改为分析最近3天
const threeDaysAgo = new Date();
threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
const timeRange = `${formatDate(threeDaysAgo)}~${formatDate(yesterday)}`;
```

### 多时间段执行

可以配置多个执行时间：

```bash
# 每天早上8点和晚上8点
SCHEDULED_ANALYSIS_TIME=0 8,20 * * *

# 工作日早上9点，周末上午10点
# 需要配置两个不同的定时任务
```

## 监控和日志

### 服务器日志

定时任务执行时会输出详细日志：

```
🕐 开始执行定时批量分析...
📋 找到 3 个分析项:
   1. 编程群分析 (AI 编程互助会 07 群)
   2. 科学群分析 (小朋友学科学)
   3. 读者群分析 (松节油读者群)

🔄 开始执行定时分析: 编程群分析
✅ 编程群分析 定时分析完成，ID: 20250617_082301_programming
⏳ 等待 3 秒后继续下一个分析...

📊 定时分析完成汇总:
✅ 成功: 2 个
⚠️  跳过: 1 个
❌ 失败: 0 个
```

### Web界面监控

在"定时分析管理"区域可以：
- 查看定时任务启用状态
- 查看配置的分析项数量
- 手动触发测试
- 刷新状态信息

## 最佳实践

### 1. 时间选择建议
- **个人使用**：建议设置在早上8-9点
- **团队使用**：建议设置在工作日早上
- **避免高峰**：不要设置在系统繁忙时段

### 2. 分析项配置
- 保持分析项数量适中（建议不超过10个）
- 定期检查群聊名称是否变更
- 优化分析提示词，提高分析质量

### 3. 资源管理
- 监控API调用额度
- 定期清理历史分析记录
- 关注服务器性能

### 4. 备份策略
- 定期备份AI设置配置
- 保存重要的分析结果
- 记录自定义的提示词模板

## 技术架构

### 核心组件
- **node-cron**: 定时任务调度
- **Express.js**: Web服务框架
- **DeepSeek API**: AI分析服务
- **Chatlog HTTP**: 聊天数据源

### 数据流程
1. 定时任务触发
2. 读取分析项配置
3. 获取聊天数据
4. 调用AI分析
5. 保存分析结果
6. 记录执行日志

### 配置存储
- 环境变量：定时任务开关和时间
- 本地文件：AI设置配置（ai-settings.json）
- 内存状态：运行时状态管理

---

## 联系支持

如果在使用过程中遇到问题，请：

1. 查看服务器日志获取详细错误信息
2. 检查本文档的故障排除部分
3. 确认所有依赖服务正常运行
4. 验证配置文件格式正确

祝您使用愉快！🎉 